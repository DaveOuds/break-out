<html>
<canvas id="gameCanvas" width="800" height="600">
</canvas>
<script>
	//Canvas----------------------------------------------------------------------
	var canvas;
	var canvasContext;
	var fps;

	//Object declarations -----------------------------------------------------------
	var ball = {
		x : 395,
		y : 295,
		speedX : 0,
		speedY : 10,
		reset : function() {

													if(player.lives==0) {
														gameState.showGameOver=true;
														console.log("REACHED")
													}
													this.y = canvas.height/2;
													this.speedX = 0;
												}
	};

	var player = {
		score : 0,
		lives : 3,
		paddle : {x : 295, width : 100}
	};

	function Brick (x, y){
		this.x = x;
		this.y = y;
	}

	var gameState = {
		showGameOver : false,
		levelDone : false,
		level :1,
		highScore : 0
	};

	//Bricks positioning & generation---------------------------------------------
	const BRICK_HEIGHT = 20;
	const BRICK_WIDTH = 100;
	//var brickArray = [[0,0],[100,0],[200,0],[300,0],[400,0],[500,0],[600,0],[700,0]];
	var brickArray = [[400,0]]; //Test array

	function generateBrickArray(){
		brickArray= [[0,1],[0,1],[0,1],[0,1],[0,1],[0,1],[0,1],[0,1]];
		var brickArrayLength = Math.floor((Math.random() * 8)+1);
		for(var i=0; i < brickArrayLength;i++){
			var brickArrayPosition = Math.floor(Math.random() * brickArrayLength);
			var brickPosition= brickArrayPosition*100;
			if( (brickArray[brickArrayPosition] != [0,1])) brickArray[brickArrayPosition] =[brickPosition,0];
			else i--;
		 }
	}

	//Event listeners ------------------------------------------------------------
	function calMousePos(evt){
		var rect = canvas.getBoundingClientRect();
		var root = document.documentElement;

		var mouseX = evt.clientX - rect.left - root.scrollLeft;
		var mouseY = evt.clientY - rect.top - root.scrollTop;

		return { x:mouseX, y:mouseY };
	}

	function handleMouseClick(evt){
		if(gameState.showGameOver){
			player.score = 0;
			player.lives = 3;
			gameState.level = 0;
			ball.speedX = 0;
			ball.speedY = 10;
			gameState.showGameOver=false;
		} else if (gameState.levelDone){
			ball.reset();
			gameState.levelDone=false;
			ball.speedX = 0;
			ball.speedY += 5;
		}
	}

	//Onload function ------------------------------------------------------------
	window.onload = function(){
		canvas = document.getElementById('gameCanvas');
		canvasContext = canvas.getContext('2d');



		fps = 30;
		setInterval(function(){
						drawEverything();
						moveEverything();
					}, 1000/fps);

		canvas.addEventListener('mousemove',
								function(evt){
									var mousePos = calMousePos(evt);
									player.paddle.x = mousePos.x-50;
								})
		canvas.addEventListener('mousedown', handleMouseClick)
	}

	//Move functions -------------------------------------------------------------

	function moveEverything(){
		if(gameState.showGameOver || gameState.levelDone) return;
		ball.x += ball.speedX;
		ball.y += ball.speedY;

		if (ball.y > canvas.height) {																								// Bottom Reflect
			if(( ball.x > player.paddle.x) && (ball.x < player.paddle.x+player.paddle.width)){
				ball.speedY *= -1;

				var deltaX = ball.x - (player.paddle.x+player.paddle.width/2);
				ball.speedX = deltaX * 0.35;
			} else {
				player.lives--;
				ball.reset();
			}
		}

		if (ball.x < 0 || ball.x > canvas.width) ball.speedX *= -1;									// Left/Right reflect

		if(ball.y < 0) ball.speedY*=-1;																							// Top Reflect

		for(i = 0; i < brickArray.length; i++){
			if(ball.y <= brickArray[i][1]+BRICK_HEIGHT && ((ball.x > brickArray[i][0]) && (ball.x < brickArray[i][0]+BRICK_WIDTH))) {
				ball.speedY*=-1;
				brickArray.splice(i,1);
				player.score+=100;
				if(brickArray.length == 0 ) {
					gameState.levelDone=true;
					gameState.level++;
				}
			}
		}
	}

	//Draw functions -------------------------------------------------------------
	function drawEverything(){
	colorRect(0, 0, canvas.width, canvas.height, 'black');												//Background

		if(gameState.showGameOver) {
			showScreen("Game Over", "Try again?", "Click to continue")
			return;
		}

		if(gameState.levelDone) {
			showScreen("Level Complete", "Ready for level " +gameState.level +"?", "Click to continue")
			generateBrickArray()
			return;
		}

		colorRect(0, 0, canvas.width, canvas.height, 'black');											//Background
		colorRect(player.paddle.x, 590, player.paddle.width, 10, 'white');							//Paddle 1
		canvasContext.fillText(player.lives, 100, 100);
		canvasContext.fillText(player.score, 500, 100);
		colorCircle(ball.x, ball.y, 5,' white'); 																			//Ball
		for(i=0; i < brickArray.length; i++){ 																			//Bricks
			drawBrick(brickArray[i][0], brickArray[i][1]);
		}
	}

	function drawBrick (x, y){
		colorRect(x, y, BRICK_WIDTH, BRICK_HEIGHT, 'red');
		canvasContext.beginPath();
		canvasContext.lineWidth="3";
		canvasContext.strokeStyle="black";
		canvasContext.rect(x, y, BRICK_WIDTH, BRICK_HEIGHT)
		canvasContext.stroke();
	}

	function colorRect(x, y, width, height, color){
		canvasContext.fillStyle = color;
		canvasContext.fillRect(x, y, width, height);
	}

	function colorCircle(x, y, radius, color){
		canvasContext.fillStyle = color;
		canvasContext.beginPath();
		canvasContext.arc(x, y, radius, 0, Math.PI*2, true);
		canvasContext.fill();
	}

	function showScreen(message1, message2, message3){
			canvasContext.fillStyle = 'white';
			canvasContext.fillText(message1, 350 ,100);
			canvasContext.fillText(message2, 350 ,120);
			canvasContext.fillText(message3, 350 ,500);
	}
</script>
</html>
